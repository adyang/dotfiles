#!/bin/bash

main() {
  if [[ "${CI}" != 'true' ]]; then
    sudo_keep_alive
  fi
  brew_packages
  symlink_dotfiles
}

sudo_keep_alive() {
  sudo --validate
  while true; do sudo --non-interactive true; sleep 20; kill -0 "$$" || exit; done 2>/dev/null &
}

brew_packages() {
  if ! type brew &>/dev/null; then
    /usr/bin/ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"
  fi
  brew bundle --verbose
}

symlink_dotfiles() {
  echo "Symlinking dotfiles to ${HOME} ..."
  local script_dir="$(dirname "$(realpath -s "${BASH_SOURCE[0]}")")"
  shopt -s dotglob
  local filepath
  for filepath in "${script_dir}/home"/*; do
    local file="${filepath##*/}"
    backup_if_regular_file "${HOME}/${file}"
    symlink_if_absent "${filepath}" "${HOME}/${file}"
  done
  shopt -u dotglob
}

backup_if_regular_file() {
  local filepath="$1"
  if [[ -f "${filepath}" && ! -L "${filepath}" ]]; then
    mv -v "${filepath}" "${filepath}.bak"
  fi
}

symlink_if_absent() {
  local src="$1"
  local target="$2"
  if [[ ! -e "${target}" ]]; then
    ln -sv "${src}" "${target}"
  fi
}

main "$@"

